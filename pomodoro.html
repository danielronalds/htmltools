<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s ease;
        }

        body.work-mode {
            background: linear-gradient(135deg, #d95550 0%, #c44b47 50%, #b8403c 100%);
        }

        body.break-mode {
            background: linear-gradient(135deg, #4c9195 0%, #3d8387 50%, #2e7579 100%);
        }

        body.light-mode {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 50%, #d5dbe1 100%);
            color: #333;
        }

        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            max-width: 400px;
            width: 90%;
        }

        .session-type {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .round-counter {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 1.5rem;
        }

        .timer-display {
            font-size: 6rem;
            font-weight: 700;
            color: white;
            margin: 1rem 0;
            font-variant-numeric: tabular-nums;
        }

        .duration-selector {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .duration-btn {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(255, 255, 255, 0.5);
            background: transparent;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .duration-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .duration-btn.active {
            background: white;
            color: #333;
            border-color: white;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .control-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.1s ease, opacity 0.2s ease;
        }

        .control-btn:hover {
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .start-btn {
            background: white;
            color: #333;
        }

        .reset-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .skip-break-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.75rem 1rem;
        }

        .skip-break-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
        }

        .skip-break-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .youtube-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .youtube-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .youtube-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
        }

        .youtube-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .youtube-input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.6);
        }

        .youtube-status {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 0.5rem;
        }

        #youtube-player,
        #break-youtube-player {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
        }

        .advanced-section {
            margin-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .advanced-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            user-select: none;
        }

        .advanced-header:hover {
            color: white;
        }

        .advanced-header i {
            transition: transform 0.3s ease;
        }

        .advanced-section.open .advanced-header i {
            transform: rotate(180deg);
        }

        .advanced-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .advanced-section.open .advanced-content {
            max-height: 200px;
        }

        .back-btn {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: white;
            text-decoration: none;
            font-size: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: background 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theme-toggle {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        body.light-mode .theme-toggle {
            background: rgba(217, 85, 80, 0.1);
            color: #d95550;
        }

        body.light-mode .theme-toggle:hover {
            background: rgba(217, 85, 80, 0.2);
        }

        body.light-mode .container {
            background: rgba(255, 255, 255, 0.3);
        }

        body.light-mode .session-type,
        body.light-mode .timer-display {
            color: #333;
        }

        body.light-mode .round-counter {
            color: rgba(51, 51, 51, 0.8);
        }

        body.light-mode .duration-btn {
            border-color: rgba(51, 51, 51, 0.5);
            color: #333;
        }

        body.light-mode .duration-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        body.light-mode .duration-btn.active {
            background: #d95550;
            color: white;
            border-color: #d95550;
        }

        body.light-mode .start-btn {
            background: #d95550;
            color: white;
        }

        body.light-mode .reset-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode .skip-break-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode .skip-break-btn:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.15);
        }

        body.light-mode .youtube-section {
            border-top-color: rgba(51, 51, 51, 0.2);
        }

        body.light-mode .youtube-label {
            color: rgba(51, 51, 51, 0.9);
        }

        body.light-mode .youtube-input {
            border-color: rgba(51, 51, 51, 0.3);
            background: rgba(255, 255, 255, 0.3);
            color: #333;
        }

        body.light-mode .youtube-input::placeholder {
            color: rgba(51, 51, 51, 0.5);
        }

        body.light-mode .youtube-input:focus {
            border-color: rgba(51, 51, 51, 0.5);
        }

        body.light-mode .youtube-status {
            color: rgba(51, 51, 51, 0.7);
        }

        body.light-mode .advanced-section {
            border-top-color: rgba(51, 51, 51, 0.2);
        }

        body.light-mode .advanced-header {
            color: rgba(51, 51, 51, 0.9);
        }

        body.light-mode .advanced-header:hover {
            color: #333;
        }

        body.light-mode .back-btn {
            background: rgba(217, 85, 80, 0.1);
            color: #d95550;
        }

        body.light-mode .back-btn:hover {
            background: rgba(217, 85, 80, 0.2);
        }

        /* Light mode break styles - use teal instead of red */
        body.light-mode.break-mode .theme-toggle {
            background: rgba(76, 145, 149, 0.1);
            color: #4c9195;
        }

        body.light-mode.break-mode .theme-toggle:hover {
            background: rgba(76, 145, 149, 0.2);
        }

        body.light-mode.break-mode .duration-btn.active {
            background: #4c9195;
            border-color: #4c9195;
        }

        body.light-mode.break-mode .start-btn {
            background: #4c9195;
        }

        body.light-mode.break-mode .back-btn {
            background: rgba(76, 145, 149, 0.1);
            color: #4c9195;
        }

        body.light-mode.break-mode .back-btn:hover {
            background: rgba(76, 145, 149, 0.2);
        }

        body.light-mode.break-mode .skip-break-btn {
            background: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        body.light-mode.break-mode .skip-break-btn:hover:not(:disabled) {
            background: rgba(0, 0, 0, 0.15);
        }

        /* YouTube input wrapper */
        .youtube-input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .youtube-input-wrapper .youtube-input {
            flex: 1;
        }

        .history-btn {
            padding: 0 0.75rem;
            border: none;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .history-btn:hover {
            transform: scale(1.05);
        }

        body.light-mode .history-btn {
            background: #d95550;
            color: white;
        }

        body.light-mode.break-mode .history-btn {
            background: #4c9195;
        }

        /* History dialog */
        .history-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
            border: none;
            border-radius: 16px;
            background: rgba(180, 60, 55, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
        }

        body.break-mode .history-dialog {
            background: rgba(45, 115, 120, 0.95);
        }

        .history-dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .history-header h2 {
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            transition: color 0.2s ease;
        }

        .close-btn:hover {
            color: white;
        }

        .history-list {
            max-height: 50vh;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .history-item-url {
            flex: 1;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 0.5rem;
        }

        .history-item-delete {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            transition: opacity 0.2s ease;
            opacity: 0.7;
        }

        .history-item-delete:hover {
            opacity: 1;
        }

        .history-empty {
            padding: 2rem 1.5rem;
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .history-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .clear-history-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .clear-history-btn:hover {
            transform: scale(1.02);
        }

        body.light-mode .clear-history-btn {
            background: #d95550;
            color: white;
        }

        body.light-mode.break-mode .clear-history-btn {
            background: #4c9195;
        }

        /* Light mode dialog */
        body.light-mode .history-dialog {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
        }

        body.light-mode .history-header {
            border-bottom-color: rgba(51, 51, 51, 0.1);
        }

        body.light-mode .close-btn {
            color: rgba(51, 51, 51, 0.7);
        }

        body.light-mode .close-btn:hover {
            color: #333;
        }

        body.light-mode .history-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        body.light-mode .history-item-url {
            color: #333;
        }

        body.light-mode .history-item-delete {
            color: #333;
        }

        body.light-mode .history-empty {
            color: rgba(51, 51, 51, 0.5);
        }

        body.light-mode .history-footer {
            border-top-color: rgba(51, 51, 51, 0.1);
        }
    </style>
</head>
<body class="work-mode">
    <a href="index.html" class="back-btn">
        <i class="fa-solid fa-arrow-left"></i>
        <span>Back to Tools</span>
    </a>

    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
        <i class="fa-solid fa-sun"></i>
    </button>

    <div class="container">
        <div class="session-type" id="session-type">Work Session</div>
        <div class="round-counter" id="round-counter">Round 1 of 4</div>

        <div class="timer-display" id="timer-display">25:00</div>

        <div class="duration-selector">
            <button class="duration-btn" data-duration="10">10 min</button>
            <button class="duration-btn" data-duration="15">15 min</button>
            <button class="duration-btn active" data-duration="25">25 min</button>
        </div>

        <div class="controls">
            <button class="control-btn start-btn" id="start-btn">Start</button>
            <button class="control-btn reset-btn" id="reset-btn">Reset</button>
            <button class="control-btn skip-break-btn" id="skip-break-btn" title="Start Break">
                <i class="fa-solid fa-mug-hot"></i>
            </button>
        </div>

        <div class="youtube-section">
            <label class="youtube-label" for="youtube-url">YouTube URL (audio will play during work sessions)</label>
            <div class="youtube-input-wrapper">
                <input type="text" id="youtube-url" class="youtube-input" placeholder="https://www.youtube.com/watch?v=...">
                <button id="history-btn" class="history-btn" title="YouTube URL History">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                </button>
            </div>
            <div class="youtube-status" id="youtube-status"></div>
        </div>

        <div class="advanced-section" id="advanced-section">
            <div class="advanced-header" id="advanced-header">
                <span>Advanced Features</span>
                <i class="fa-solid fa-chevron-down"></i>
            </div>
            <div class="advanced-content">
                <label class="youtube-label" for="break-youtube-url">
                    YouTube URL (audio will play during breaks)
                </label>
                <div class="youtube-input-wrapper">
                    <input type="text" id="break-youtube-url" class="youtube-input"
                           placeholder="https://www.youtube.com/watch?v=...">
                    <button id="break-history-btn" class="history-btn" title="YouTube URL History">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                </div>
                <div class="youtube-status" id="break-youtube-status"></div>
            </div>
        </div>
    </div>

    <dialog id="history-dialog" class="history-dialog">
        <div class="history-header">
            <h2>YouTube URL History</h2>
            <button id="close-history" class="close-btn">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="history-list" class="history-list"></div>
        <div class="history-footer">
            <button id="clear-history" class="clear-history-btn">Clear All History</button>
        </div>
    </dialog>

    <div id="youtube-player"></div>
    <div id="break-youtube-player"></div>

    <script>
        const THEME_KEY = 'theme-preference';
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('i');

        function setTheme(isLight) {
            document.body.classList.toggle('light-mode', isLight);
            themeIcon.className = isLight ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
            localStorage.setItem(THEME_KEY, isLight ? 'light' : 'dark');
        }

        // Load saved theme
        const savedTheme = localStorage.getItem(THEME_KEY);
        if (savedTheme === 'light') {
            setTheme(true);
        }

        themeToggle.addEventListener('click', () => {
            setTheme(!document.body.classList.contains('light-mode'));
        });

        const STORAGE_KEY = 'pomodoro-state';
        const YOUTUBE_HISTORY_KEY = 'pomodoro-youtube-history';

        // State
        const state = {
            sessionDuration: 25,
            shortBreakDuration: 5,
            longBreakDuration: 15,
            currentRound: 1,
            totalRounds: 4,
            isRunning: false,
            isBreak: false,
            timeRemaining: 25 * 60,
            intervalId: null,
            youtubePlayer: null,
            youtubeReady: false,
            breakYoutubePlayer: null,
            advancedOpen: false
        };

        // History dialog context - tracks which input triggered the dialog
        let historyDialogContext = 'work';

        // localStorage functions
        function saveState() {
            const toSave = {
                sessionDuration: state.sessionDuration,
                youtubeUrl: document.getElementById('youtube-url').value,
                breakYoutubeUrl: document.getElementById('break-youtube-url').value,
                advancedOpen: state.advancedOpen,
                currentRound: state.currentRound,
                timeRemaining: state.timeRemaining,
                isBreak: state.isBreak,
                isRunning: state.isRunning,
                lastSaveTime: Date.now()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.sessionDuration) {
                        state.sessionDuration = parsed.sessionDuration;
                    }
                    if (parsed.currentRound) {
                        state.currentRound = parsed.currentRound;
                    }
                    if (parsed.youtubeUrl) {
                        document.getElementById('youtube-url').value = parsed.youtubeUrl;
                    }
                    if (parsed.breakYoutubeUrl) {
                        document.getElementById('break-youtube-url').value = parsed.breakYoutubeUrl;
                    }
                    if (typeof parsed.advancedOpen === 'boolean') {
                        state.advancedOpen = parsed.advancedOpen;
                        if (state.advancedOpen) {
                            advancedSection.classList.add('open');
                        }
                    }
                    if (typeof parsed.isBreak === 'boolean') {
                        state.isBreak = parsed.isBreak;
                    }
                    if (typeof parsed.timeRemaining === 'number') {
                        state.timeRemaining = parsed.timeRemaining;

                        // Account for elapsed time if timer was running
                        if (parsed.isRunning && parsed.lastSaveTime) {
                            const elapsedSeconds = Math.floor((Date.now() - parsed.lastSaveTime) / 1000);
                            state.timeRemaining = Math.max(0, state.timeRemaining - elapsedSeconds);
                        }
                    } else {
                        // Fallback for old saved data without timeRemaining
                        state.timeRemaining = state.sessionDuration * 60;
                    }
                    if (parsed.isRunning) {
                        // Auto-start the timer after initialization
                        setTimeout(() => {
                            if (state.timeRemaining > 0) {
                                startTimer();
                            } else {
                                // Timer expired while page was closed
                                if (state.isBreak) {
                                    switchToWork();
                                } else {
                                    switchToBreak();
                                }
                            }
                        }, 0);
                    }
                } catch (e) {
                    console.error('Failed to load saved state:', e);
                }
            }
        }

        function clearState() {
            localStorage.removeItem(STORAGE_KEY);
        }

        // YouTube history functions
        function loadYoutubeHistory() {
            const saved = localStorage.getItem(YOUTUBE_HISTORY_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return [];
                }
            }
            return [];
        }

        function saveYoutubeHistory(history) {
            localStorage.setItem(YOUTUBE_HISTORY_KEY, JSON.stringify(history));
        }

        async function fetchVideoTitle(url) {
            try {
                const response = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
                if (response.ok) {
                    const data = await response.json();
                    return data.title;
                }
            } catch (e) {
                console.error('Failed to fetch video title:', e);
            }
            return null;
        }

        async function addToYoutubeHistory(url) {
            if (!url) return;
            const history = loadYoutubeHistory();
            // Remove if already exists (to move to top)
            const existingIndex = history.findIndex(item =>
                (typeof item === 'string' ? item : item.url) === url
            );
            if (existingIndex > -1) {
                history.splice(existingIndex, 1);
            }
            // Fetch video title
            const title = await fetchVideoTitle(url);
            // Add to beginning
            history.unshift({ url, title: title || url });
            saveYoutubeHistory(history);
        }

        function removeFromYoutubeHistory(url) {
            const history = loadYoutubeHistory();
            const index = history.findIndex(item =>
                (typeof item === 'string' ? item : item.url) === url
            );
            if (index > -1) {
                history.splice(index, 1);
                saveYoutubeHistory(history);
            }
        }

        function clearYoutubeHistory() {
            localStorage.removeItem(YOUTUBE_HISTORY_KEY);
        }

        // DOM Elements
        const timerDisplay = document.getElementById('timer-display');
        const sessionType = document.getElementById('session-type');
        const roundCounter = document.getElementById('round-counter');
        const startBtn = document.getElementById('start-btn');
        const skipBreakBtn = document.getElementById('skip-break-btn');
        const resetBtn = document.getElementById('reset-btn');
        const durationBtns = document.querySelectorAll('.duration-btn');
        const youtubeInput = document.getElementById('youtube-url');
        const youtubeStatus = document.getElementById('youtube-status');
        const historyBtn = document.getElementById('history-btn');
        const historyDialog = document.getElementById('history-dialog');
        const historyList = document.getElementById('history-list');
        const closeHistoryBtn = document.getElementById('close-history');
        const clearHistoryBtn = document.getElementById('clear-history');
        const advancedSection = document.getElementById('advanced-section');
        const advancedHeader = document.getElementById('advanced-header');
        const breakYoutubeInput = document.getElementById('break-youtube-url');
        const breakYoutubeStatus = document.getElementById('break-youtube-status');
        const breakHistoryBtn = document.getElementById('break-history-btn');

        // History dialog functions
        function renderHistoryDialog() {
            const history = loadYoutubeHistory();
            historyList.innerHTML = '';

            if (history.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No YouTube URLs in history</div>';
                return;
            }

            history.forEach(entry => {
                // Handle both old format (string) and new format (object)
                const url = typeof entry === 'string' ? entry : entry.url;
                const title = typeof entry === 'string' ? entry : entry.title;

                const item = document.createElement('div');
                item.className = 'history-item';

                const titleSpan = document.createElement('span');
                titleSpan.className = 'history-item-url';
                titleSpan.textContent = title;
                titleSpan.title = url;
                titleSpan.addEventListener('click', () => selectHistoryItem(url));

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'history-item-delete';
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.title = 'Remove from history';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFromYoutubeHistory(url);
                    renderHistoryDialog();
                });

                item.appendChild(titleSpan);
                item.appendChild(deleteBtn);
                historyList.appendChild(item);
            });
        }

        function selectHistoryItem(url) {
            const inputEl = historyDialogContext === 'work' ? youtubeInput : breakYoutubeInput;
            const statusEl = historyDialogContext === 'work' ? youtubeStatus : breakYoutubeStatus;

            inputEl.value = url;
            historyDialog.close();

            const videoId = extractVideoId(url);
            if (videoId) {
                statusEl.textContent = 'Loading...';
                if (historyDialogContext === 'work') {
                    initYoutubePlayer(videoId);
                } else {
                    initBreakYoutubePlayer(videoId);
                }
            }
            saveState();
        }

        // Load YouTube IFrame API
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // YouTube API callback
        window.onYouTubeIframeAPIReady = function() {
            state.youtubeReady = true;
        };

        // Extract video ID from YouTube URL
        function extractVideoId(url) {
            if (!url) return null;

            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                /youtube\.com\/watch\?.*v=([^&\n?#]+)/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        // Initialize or update YouTube player
        function initYoutubePlayer(videoId) {
            if (!state.youtubeReady) {
                youtubeStatus.textContent = 'YouTube API loading...';
                return;
            }

            if (state.youtubePlayer) {
                state.youtubePlayer.destroy();
            }

            state.youtubePlayer = new YT.Player('youtube-player', {
                height: '1',
                width: '1',
                videoId: videoId,
                playerVars: {
                    autoplay: 0,
                    controls: 0,
                    disablekb: 1,
                    fs: 0,
                    modestbranding: 1,
                    rel: 0
                },
                events: {
                    onReady: () => {
                        youtubeStatus.textContent = 'Audio ready';
                        // Auto-play if timer is running and not on break
                        if (state.isRunning && !state.isBreak) {
                            playAudio();
                        }
                    },
                    onError: (e) => {
                        youtubeStatus.textContent = 'Error loading video';
                    }
                }
            });
        }

        // Play YouTube audio
        function playAudio() {
            if (state.youtubePlayer && typeof state.youtubePlayer.playVideo === 'function') {
                state.youtubePlayer.playVideo();
            }
        }

        // Pause YouTube audio
        function pauseAudio() {
            if (state.youtubePlayer && typeof state.youtubePlayer.pauseVideo === 'function') {
                state.youtubePlayer.pauseVideo();
            }
        }

        // Initialize break YouTube player
        function initBreakYoutubePlayer(videoId) {
            if (!state.youtubeReady) {
                breakYoutubeStatus.textContent = 'YouTube API loading...';
                return;
            }

            if (state.breakYoutubePlayer) {
                state.breakYoutubePlayer.destroy();
            }

            state.breakYoutubePlayer = new YT.Player('break-youtube-player', {
                height: '1',
                width: '1',
                videoId: videoId,
                playerVars: {
                    autoplay: 0,
                    controls: 0,
                    disablekb: 1,
                    fs: 0,
                    modestbranding: 1,
                    rel: 0
                },
                events: {
                    onReady: () => {
                        breakYoutubeStatus.textContent = 'Audio ready';
                        // Auto-play if timer is running and on break
                        if (state.isRunning && state.isBreak) {
                            playBreakAudio();
                        }
                    },
                    onError: (e) => {
                        breakYoutubeStatus.textContent = 'Error loading video';
                    }
                }
            });
        }

        // Play break YouTube audio
        function playBreakAudio() {
            if (state.breakYoutubePlayer && typeof state.breakYoutubePlayer.playVideo === 'function') {
                state.breakYoutubePlayer.playVideo();
            }
        }

        // Pause break YouTube audio
        function pauseBreakAudio() {
            if (state.breakYoutubePlayer && typeof state.breakYoutubePlayer.pauseVideo === 'function') {
                state.breakYoutubePlayer.pauseVideo();
            }
        }

        // Format time as MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update display
        function updateDisplay() {
            timerDisplay.textContent = formatTime(state.timeRemaining);
            sessionType.textContent = state.isBreak ? 'Break Time' : 'Work Session';
            roundCounter.textContent = `Round ${state.currentRound} of ${state.totalRounds}`;
            startBtn.textContent = state.isRunning ? 'Pause' : 'Start';
            skipBreakBtn.disabled = state.isBreak;

            document.body.classList.toggle('work-mode', !state.isBreak);
            document.body.classList.toggle('break-mode', state.isBreak);
        }

        // Timer tick
        function tick() {
            state.timeRemaining--;

            if (state.timeRemaining <= 0) {
                if (state.isBreak) {
                    switchToWork();
                } else {
                    switchToBreak();
                }
            }

            updateDisplay();
            saveState();
        }

        // Switch to break mode
        function switchToBreak() {
            state.isBreak = true;
            pauseAudio();

            // Determine break duration
            const isLongBreak = state.currentRound >= state.totalRounds;
            state.timeRemaining = (isLongBreak ? state.longBreakDuration : state.shortBreakDuration) * 60;

            // Auto-play break music if timer is running
            if (state.isRunning) {
                playBreakAudio();
            }

            updateDisplay();
            saveState();
        }

        // Switch to work mode
        function switchToWork() {
            state.isBreak = false;
            pauseBreakAudio();

            // Increment round after break
            if (state.currentRound >= state.totalRounds) {
                state.currentRound = 1;
            } else {
                state.currentRound++;
            }

            state.timeRemaining = state.sessionDuration * 60;

            if (state.isRunning) {
                playAudio();
            }

            updateDisplay();
            saveState();
        }

        // Start timer
        function startTimer() {
            state.isRunning = true;
            state.intervalId = setInterval(tick, 1000);

            if (state.isBreak) {
                playBreakAudio();
            } else {
                playAudio();
            }

            updateDisplay();
            saveState();
        }

        // Pause timer
        function pauseTimer() {
            state.isRunning = false;
            clearInterval(state.intervalId);
            state.intervalId = null;
            pauseAudio();
            pauseBreakAudio();
            updateDisplay();
            saveState();
        }

        // Reset timer
        function resetTimer() {
            pauseTimer();
            state.sessionDuration = 25;
            state.currentRound = 1;
            state.isBreak = false;
            state.timeRemaining = state.sessionDuration * 60;
            // Reset duration buttons
            durationBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('[data-duration="25"]').classList.add('active');
            saveState();
            updateDisplay();
        }

        // Event Listeners
        startBtn.addEventListener('click', () => {
            if (state.isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        });

        resetBtn.addEventListener('click', resetTimer);

        skipBreakBtn.addEventListener('click', () => {
            if (state.isBreak) return;
            switchToBreak();
        });

        durationBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (state.isRunning) return;

                durationBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                state.sessionDuration = parseInt(btn.dataset.duration);
                if (!state.isBreak) {
                    state.timeRemaining = state.sessionDuration * 60;
                }
                updateDisplay();
                saveState();
            });
        });

        youtubeInput.addEventListener('change', () => {
            const videoId = extractVideoId(youtubeInput.value);
            if (videoId) {
                youtubeStatus.textContent = 'Loading...';
                initYoutubePlayer(videoId);
                addToYoutubeHistory(youtubeInput.value);
            } else if (youtubeInput.value) {
                youtubeStatus.textContent = 'Invalid YouTube URL';
            } else {
                youtubeStatus.textContent = '';
                if (state.youtubePlayer) {
                    state.youtubePlayer.destroy();
                    state.youtubePlayer = null;
                }
            }
            saveState();
        });

        // Advanced section toggle
        advancedHeader.addEventListener('click', () => {
            state.advancedOpen = !state.advancedOpen;
            advancedSection.classList.toggle('open', state.advancedOpen);
            saveState();
        });

        // Break music input change handler
        breakYoutubeInput.addEventListener('change', () => {
            const videoId = extractVideoId(breakYoutubeInput.value);
            if (videoId) {
                breakYoutubeStatus.textContent = 'Loading...';
                initBreakYoutubePlayer(videoId);
                addToYoutubeHistory(breakYoutubeInput.value);
            } else if (breakYoutubeInput.value) {
                breakYoutubeStatus.textContent = 'Invalid YouTube URL';
            } else {
                breakYoutubeStatus.textContent = '';
                if (state.breakYoutubePlayer) {
                    state.breakYoutubePlayer.destroy();
                    state.breakYoutubePlayer = null;
                }
            }
            saveState();
        });

        // Break history button
        breakHistoryBtn.addEventListener('click', () => {
            historyDialogContext = 'break';
            renderHistoryDialog();
            historyDialog.showModal();
        });

        // History dialog event listeners
        historyBtn.addEventListener('click', () => {
            historyDialogContext = 'work';
            renderHistoryDialog();
            historyDialog.showModal();
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyDialog.close();
        });

        clearHistoryBtn.addEventListener('click', () => {
            clearYoutubeHistory();
            historyDialog.close();
        });

        historyDialog.addEventListener('click', (e) => {
            if (e.target === historyDialog) {
                historyDialog.close();
            }
        });

        // Initialize
        loadState();

        // Update duration button UI based on loaded state
        durationBtns.forEach(b => {
            b.classList.remove('active');
            if (parseInt(b.dataset.duration) === state.sessionDuration) {
                b.classList.add('active');
            }
        });

        // Initialize YouTube player if URL was saved
        const savedUrl = youtubeInput.value;
        if (savedUrl) {
            const videoId = extractVideoId(savedUrl);
            if (videoId && state.youtubeReady) {
                initYoutubePlayer(videoId);
            } else if (videoId) {
                // Wait for YouTube API to be ready
                const checkReady = setInterval(() => {
                    if (state.youtubeReady) {
                        clearInterval(checkReady);
                        initYoutubePlayer(videoId);
                    }
                }, 100);
            }
        }

        // Initialize break YouTube player if URL was saved
        const savedBreakUrl = breakYoutubeInput.value;
        if (savedBreakUrl) {
            const videoId = extractVideoId(savedBreakUrl);
            if (videoId && state.youtubeReady) {
                initBreakYoutubePlayer(videoId);
            } else if (videoId) {
                // Wait for YouTube API to be ready
                const checkBreakReady = setInterval(() => {
                    if (state.youtubeReady) {
                        clearInterval(checkBreakReady);
                        initBreakYoutubePlayer(videoId);
                    }
                }, 100);
            }
        }

        updateDisplay();

        // Escape key closes dialog or returns to index
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (historyDialog.open) {
                    historyDialog.close();
                } else {
                    window.location.href = 'index.html';
                }
            }
        });
    </script>
</body>
</html>
